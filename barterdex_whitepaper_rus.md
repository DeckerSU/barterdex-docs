## barterDEX whitepaper
*unoffical russian translate by **Decker***

* Оригинал документа: [barterDEX_whitepaper.rtf](./barterDEX_whitepaper.rtf) 
* Статус перевода: Черновик 1.0

barterDEX - децентрализованная биржа обмена монет на основе технологии [*атомарного свопа*](http://probitcoin.ru/2017/09/23/%D0%9A%D0%B0%D0%BA-%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0%D0%B5%D1%82-%D1%82%D0%B5%D1%85%D0%BD%D0%BE%D0%BB%D0%BE%D0%B3%D0%B8%D1%8F-atomic-swap/)  (eng, atomic swap - здесь, атомарный, является термином, который означает что обмен совершится только при выполнении всех условий в системе, своп - соответственно обмен, далее по тексту, вместо atomic swap мы будем употреблять термин "атомарный своп").

bartedDEX - результат многолетних разработок и большого количества "итерированных версий", где каждая новая итерация (версия) добавляет следующий уровень требуемой функциональности, которая приближает проект к цели широкомасштабного внедрения.

В текущей версии в barterDEX была добавлена поддержка [SPV кошельков](https://bits.media/news/printsipy-spv-bezopasnosti-i-nuzhen-li-ryadovomu-polzovatelyu-bitkoina-polnyy-uzel/) на базе Electrum в дополнение к десяткам "обычных кошельков", запущенных на базе полных узлов. Во внутренней реализации barterDEX предусмотрен определенный уровень абстракции для SPV-кошельков и обычных кошельков, таким образом большинство API работают прозрачно для того и другого типа кошельков. Также, текущая реализация barterDEX реализует "Liquidity Multiplication" ("Умножение Ликвидности"), которое позволяет использовать одни и те же средства для запросов в нескольких orderbook'ах (направлениях обмена), где первый выполнившийся ордер завершает сделку.

(*Примечание: *на обычных биржах, принцип Liquidity Multiplication не поддерживается, так, например, осуществляя обмен 1 BTC на какую-либо другую монету вы вынуждены "заморозить" 1 BTC в ордере и пока вы не отмените его, вы не сможете использовать эти 1 BTC в других направлениях обмена, barterDEX обладает более широкими возможностями, обладая 1 BTC - вы можете выставить ордеры одновременно на нескольких рынках, например KMD/BTC, ZEC/BTC и т.п., которые кажутся вам наиболее выгодными, при этом средства не будут "заморожены" и обмен может быть произведен, как по одному направлению, так и по другому, в зависимости от того какой ордер "сработает" первым).

Это дает особые преимущества трейдерам, которые предпочитают ждать дампов на нескольких рынках. В теории, подобную функцию может реализовать практически любая биржа, однако, на данный момент практически никто не реализует подобной технологии. Все выставленные ордеры на 100% обеспечиваются реальными средствами, однако, эти средства могут быть частью 25-ю различных ордеров, а не одного.

За исключением вызовов самого Electrum API и некоторых различий в формате возвращаемого JSON для методов вроде "listunspent" можно создать модель API, которая будет одинаковой для всех монет. Ниже приведен список текущих API с их параметрами (также, на данный момент существует документ shossain'а - [barterDEX_API_Summary_by_Category.doc](./barterDEX_API_Summary_by_Category.doc) , который содержит более подробное описание API barterDEX):

	pricearray(base, rel, starttime=0, endtime=-1, timescale=60) -> [timestamp, avebid, aveask, highbid, lowask]
	setprice(base, rel, price)
	autoprice(base, rel, minprice, margin, refbase, refrel, factor, offset)*
	goal(coin=*, val=<autocalc>)
	myprice(base, rel)
	enable(coin)
	disable(coin)
	notarizations(coin)
	parselog()
	statsdisp(starttime=0, endtime=0, gui=, pubkey=)
	getrawtransaction(coin, txid)
	inventory(coin)
	bestfit(rel, relvolume)
	lastnonce()
	buy(base, rel, price, relvolume, timeout=10, duration=3600, nonce, pubkey=)
	sell(base, rel, price, basevolume, timeout=10, duration=3600, nonce, pubkey=)
	withdraw(coin, outputs[])
	sendrawtransaction(coin, signedtx)
	swapstatus()
	swapstatus(coin, limit=10)
	swapstatus(base, rel, limit=10)
	swapstatus(requestid, quoteid)
	recentswaps(limit=3)

**public API:**

	getcoins()
	getcoin(coin)
	portfolio()
	getpeers()
	passphrase(passphrase, gui)
	listunspent(coin, address)
	setconfirms(coin, numconfirms, maxconfirms=6)
	trust(pubkey, trust) # positive to trust, 0 for normal, negative to blacklist
	balance(coin, address)
	orderbook(base, rel, duration=3600)
	getprices(base, rel)
	sendmessage(base=coin, rel=, pubkey=zero, <argjson method2>)
	getmessages(firsti=0, num=100)
	deletemessages(firsti=0, num=100)
	secretaddresses(prefix='secretaddress', passphrase, num=10, pubtype=60, taddr=0)
	electrum(coin, ipaddr, port)
	snapshot(coin, height)
	snapshot_balance(coin, height, addresses[])
	dividends(coin, height, <args>)
	stop()
	
Кроме того, монеты с отличающимися механизмами построения транзакций на низком уровне, а также с отличающейся структурой блоков, также приводятся к универсальной модели монеты. Другими словами, вне зависимости от внутренней реализации, устройства монеты, в рамках единой модели API, достаточно указать название (symbol) монеты, чтобы получить ответ от API. Протокол Bitcoin необходим (речь идет о кошельках, демонах монет, которые вы будете использовать), но даже более старые кошельки (монеты) без поддержки опкода CLTV могут работать совместно с barterDEX.

Требования к монете в основном режиме (native mode) состоят в том, чтобы barterDEX имел возможность получить ответ на вызов gettxout через RPC и если он имеет CLTV опкод - он может быть как liquidity provider  (bob), так и liquidity taker (alice). Для монеты использующих SPV на даный момент поддреживается только liquidity taking, в силу производительности сети. Кроме того, логика заключается в том, что любой кто серьезно относится к торговле, должен быть достаточно серьезным, чтобы запустить полные кошельки монет, которыми он торгует.

(*Примечание:* Если вы никогда раньше не сталкивались с технологией атомарных свопов, не представляете кто такие bob и alice, не знакомы с терминами liquidity provider и liquidity taker, рекомендуется посмотреть следующее видео - [Show & Tell: XCAT (Zcash & Bitcoin)](https://www.youtube.com/watch?v=nPvfn138PRg)  , иллюстрирующее безопасный обмен монетами между блокчейнами ZCash и Bitcoin при помощи XCAT. barterDEX фактически реализует примерно аналогичную схему обмена, но распространяющуюся не на какие-то два конкретные блокчейна, а фактически на все монеты, которые вы используете в SPV кошельке или для которых у вас запущены полные узлы.)

Прежде чем мы перейдем к деталям атомарных свопов, есть еще один аспект barterDEX, который является довольно важным - это децентрализованный orderbook (orderbook - дословно это "книга заказов", содержащая ордеры на покупку и продажу, т.е. bids и asks).  Для реализации этого, barterDEX создает собственную децентрализованную p2p сеть, которая имеет аналоги полного ретрансляционного узла и узла, который не задействован в ретрансляции. Общая нагрузка на эту сеть минимизируется благодаря использованию комбинации иерархической передачи книги заказов (orderbook) вместе с выборкой данных. Кроме этого, существует несколько различных способов получения данных для увеличения числа узлов, которые могут полностью быть подключены к сети barterDEX.

Следует отметить, что существует возможность создания полностью отдельного набора узлов barterDEX, путем создания сети с полностью независимым набором seed узлов. Это позволяет масштабировать сеть barterDEX на произвольные уровни, поскольку, если достигнут какой-либо предел масштабирования, возникает вопрос о создании отдельной сети, которая напрямую не соединяется с другой. При таком масштабировании строится предположение о том, что каждая книга заказов (orderbook) имеет большое количество ордеров, особенно если разбиение производится на основе каждой монеты. В случае, когда желательно переходить между различными книгами заказов из различных сетей, можно было бы иметь специализированные узлы-мосты (bridge nodes), которые осуществляли бы избирательный выбор (cherry pick) нужных записей из одной сети в другую.

Поскольку адресация в сети barterDEX осуществляется с использованием публичного ключа [curve25519](https://habrahabr.ru/post/247873/), IP адрес узла не имеет никакого значения, а для не-ретрансляционных узлов он не является частью какого-либо пакета протокола barterDEX. Таким образом ваш IP адрес никак не фиксируется на уровне самого протокола обмена в barterDEX, однако, не исключена возможность существования "вредоносного ретрансляционного узла" в сети, который будет контролировать IP адреса пакетов на низком уровне и осуществлять связывание IP-адреса с публичными ключами (например, в целях логирования и попытки определения IP адресов участников транзакций). Так или иначе, barterDEX - это биржа основанная на блокчейне (распределенном реестре), который сам по себе является публичным, т.е. все транзакции в нем прозрачны и доступны для просмотра другим пользователям. Не стоит думать что barterDEX обеспечивает полностью конфеденциальный обмен, для обеспечения конфенденциальности - используйте JUMBLR.

(*Примечание:* Речь идет о том, что никакие части протокола barterDEX не включают в себя информацию об IP адресах источников или получателей транзакций, однако, как и любая система построенная на блокчейне, barterDEX не гарантирует полной анонимности или конфеденциальности ваших транзакций, также, например, как и в блокчейне Bitcoin существует возможность просмотра информации по любым транзакциям связанным с определенным адресом, также и в barterDEX информация об определенном pubkey является публичной, т.к. она является частью блокчейна).

Любой желающий может запустить собственный узел ретрансляции barterDEX, это бесплатно и не требует большой пропускной способности канала в интернет. Однако, будучи полным узлом ретрансляции в сети, вы имеете надежную связь со всеми другими узлами в сети, а следовательно более высокий шанс в процентах для начала и успешного завершения сделок. Подобного повышения надежности было бы достаточно для активных трейдеров, а также для владельцев активов DEX, другими словами, чем больше полных узлов будет запущено - тем лучше. 

(*Примечание:* запуск полного узла barterDEX помогает не только поддержке распределенной сети в целом, но также и влияет на скорость начала и завершения сделок, т.к. полный узел в сети имеет больше связей с другими узлами, а также выше шанс, на то что отправляемая им информация будет быстрее принята сетью).

Не ретрансляционный узел (non-relaying node) способен делать все то же самое, что и полный узел ретрансляции, поэтому мы ожидаем, что подавляющее большинство узлов будут не ретранслирующими узлами, и это позволит сети barterDEX масштабироваться до большого количества узлов. С 100 полными узлами могут поддерживаться тысячи нерелейных узлов, возможно, десятки тысяч, хотя пока это число не было достигнуто на практике, поэтому нам придется подождать и посмотреть, каковы на самом деле данные ограничения в реальной действительности.

Третья значительная часть barterDEX - это [исходный код Iguana](https://github.com/jl777/SuperNET/tree/master/iguana), который является "родительской веткой" для данной части barterDEX. Это позволяет создать "специальный кошелек", который будет контролировать все поддерживаемые монеты, с использованием полностью автономного набора исходного кода. Все транзакции протокола атомарного свопа - это пользовательские необработанные транзакции, которые подписываются с помощью кода Iguana. Используя команду API "withdraw" можно создать кошелек общего назначения, который использует barterDEX API. Он использует секретный ключ с парольной фразой, поэтому для него нет необходимости в создании отдельного wallet.dat, который бы поддерживался самим barterDEX'ом и он использует только один адрес, полученный из активного секретного ключа. Фактически - все монеты получают адрес, но адреса каждой монеты основаны на одном и том же секретном ключе.

(*Примечание:* возможно этот момент в официальном whitepaper написан слишком абстрактно для понимания, если пояснить смысл в двух словах, то, как вы уже поняли, barterDEX для обеспечения обмена поддерживает работу с кошельками практически всех монет, об ограничениях говорилось выше, на практике это означает то, что при работе с barterDEX вы должны придумать некую надежную секретную фразу, на основании которой будут сгенерированы приватные ключи для каждой из используемых вами монет, т.е. для каждой монеты участвующей в обмене, кошелек которой запущен у вас на ПК, на основании вашей секретной фразы будет сгенерирован специальный адрес, зависящий от этой секретной фразы, поместив средства на который вы можете начать обмен. Таким образом, если провести аналог с обычной биржей, на которой требуется регистрации, после чего вы получаете адрес той или иной монеты для размещения депозита, здесь вы просто придумываете секретную фразу и в кошельках, которые запущены у вас генерируется специальный smartaddress на основании вашей парольной фразы, который как раз и предназначен для депозита средств, которые вы планируете к обмену. Таким образом, средства предназначенные для обмена находятся на вашем локальном кошельке, а доступ к ним осуществляется при помощи назначенной вами секретной фразы. Например, если вы имеете несколько локальных кошельков: BTC, KMD, ZEC и т.п., то при вводе парольной фразы из barterDEX в кошельке каждой из этих монет будет сгенерировано по одному специальному smartaddress'у, соответствующему введенной вами парольной фразе. И именно на эти адреса, владельцем которых являетесь вы сами, вы и размещаете депозит.)

Средства, размещенные как депозит на данном smartaddress'е автоматически становятся доступными для торговли. Обратите внимание, что все средства доступны только пользователю с парольной фразой и что его секретный ключ импортируется в любые локальные кошельки. Это позволяет использовать обычный кошелек (coin daemon) для совершения транзакций, однако, необходимо быть осторожным, чтобы не использовать тот же самый utxo, который использовался начатым обменом.

(*Примечание:*  вы можете распоряжаться средствами размещенными на smartaddress'ах для депозитов и с помощью обычного кошелька, однако, здесь следуюет быть осторожным чтобы случайно не потратить тот же самый utxo на данном адресе, который уже был использован в уже начатом обмене).

### Атомарные свопы

barterDEX реализует протокол Tier Nolan'а, так как описано в соответствующей ветке [Atomic swaps using cut and choose](https://bitcointalk.org/index.php?topic=1364951) на Bitcointalk. Хотя описание протокола в данной ветке довольно техническое, оно дает довольно хорошее представление о том, почему для реализации обмена были выбраны именно атомарные сфопы. Важно отметить, что на каждом этапе / шаге данного протокола есть различные предпосылки / препятствия для перехода к следующему шагу и что независимо от того на каком этапе протокол обмена завершает свобй работу, каждая сторона в конечном итоге получает то, что она должна получить. Понимание заключается в том, что если вы не будете следовать протоколу, в конечном итоге вы заплатите штраф. 

Для достижения этого liquidity provider (в данном случае под liquidity provider имеется ввиду собственник неких активов, или проще говоря продавец, liquidity taker в данном контексте - это покупатель, т.е. лицо желающее приобрести какие-либо активы, однако, данные определения возможно не являются точными в полной мере, поэтому здесь и далее по тексту я буду употреблять оригинальные определения, а именно liquidity provider и liquidity taker, при чтении для упрощения можно воспринимать их как "продавец" и "покупатель" соответственно), которого мы будем называть Боб, должен сделать депозит, для обеспечения завершения протокола обмена с его стороны. Это означает что Бобу необходимо два различных utxo (два различных непотраченных выхода) для совершения атомарного свопа, Элис, также нуждается в двух utxo, но ее дополнительным utxo является dexfee ("комиссия"), которая требуется для обеспечения защиты orderbook'а от "спама". Без этого Элис могла бы инициировать неограниченное количество атомарных свопов, и Бобы просто бы "застряли" / "подвисли", ожидая истечения срока, чтобы получить возмещение своего депозита. С введением dexfee существуют определенные финансовые затраты и для Элис нет никакой финансовой выгода для подобного поведения, это позволяет ожидать, что никто не будет преднамеренно "спамить" в orderbook несуществующими сделками, т.к. начало каждой сделки сопряжено с расходами на dexfee.

Если не вдаваться в подробности валидации каждого шага, атомарный своп состоит из 7 транзакций, в некоторых случаях их может быть меньше. Ниже показана основная последовательность этих транзакций необходимых для полного завершения обмена с обеих сторон:


